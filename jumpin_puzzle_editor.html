<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover, user-scalable=no" />
<title>Jump In ‚Äì Pulmaeditori</title>
<style>
  :root {
    --cell: 72px;
    --bg: #6aa85b;
    --hole: #222;
    --fox1: #f48c43;
    --fox2: #d07832;
  }

  body {
    margin: 0;
    background: var(--bg);
    font-family: -apple-system, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px;
    gap: 12px;
    user-select: none;
  }

  h2 {
    color: white;
    margin: 0;
  }

  #toolbar {
    display: flex;
    gap: 16px;
    margin-bottom: 8px;
  }

  .toolbtn {
    width: 64px;
    height: 64px;
    background: #8fcc87;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 38px;
    cursor: pointer;
    border: 3px solid transparent;
  }

  .toolbtn.selected {
    border: 3px solid white;
  }

  #board {
    display: grid;
    grid-template-columns: repeat(5, var(--cell));
    grid-template-rows: repeat(5, var(--cell));
    gap: 4px;
    background: #4d8440;
    padding: 12px;
    border-radius: 18px;
    position: relative;
  }

  .cell {
    width: var(--cell);
    height: var(--cell);
    background: #7cb46b;
    border-radius: 10px;
    position: relative;
  }

  .hole {
    width: 70%;
    height: 70%;
    background: var(--hole);
    border-radius: 50%;
    position: absolute;
    top: 15%;
    left: 15%;
  }

  .mushroom, .rabbit {
    font-size: 46px;
    position: absolute;
    top: 6px;
    left: 6px;
    pointer-events: none;
  }

  .fox {
    position: absolute;
    border-radius: 12px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 56px;
    z-index: 10;
    pointer-events: none;
  }

  .fox1 { background: var(--fox1); }
  .fox2 { background: var(--fox2); }

  #buttons {
    display: flex;
    gap: 20px;
    margin-top: 10px;
    flex-wrap: wrap;
    justify-content: center;
  }

  button {
    padding: 8px 16px;
    font-size: 16px;
    border-radius: 10px;
    border: none;
    background: #3b8b3f;
    color: white;
  }
</style>
</head>
<body>

<h2>Jump In ‚Äì Pulmaeditori</h2>

<!-- ‚òÖ UUSI: Pulman numero ja nimi ‚òÖ -->
<div style="color:white; font-size:18px; text-align:center;">
  <span id="puzzleInfo"></span><br>
  Nimi: <input id="puzzleName" style="font-size:16px; padding:4px; width:200px;">
</div>

<div id="toolbar">
  <div class="toolbtn" data-tool="rabbit">üê∞</div>
  <div class="toolbtn" data-tool="mushroom">üçÑ</div>
  <div class="toolbtn" data-tool="hole"><div style="width:36px;height:36px;border-radius:50%;background:#000;"></div></div>
  <div class="toolbtn" data-tool="burrow"><div style="width:36px;height:36px;border-radius:50%;background:#000;display:flex;align-items:center;justify-content:center;font-size:20px;">üê∞</div></div>
  <div class="toolbtn" data-tool="foxh"><div style="font-size:46px;">ü¶ä</div></div>
  <div class="toolbtn" data-tool="foxv"><div style="font-size:46px;transform:rotate(90deg);">ü¶ä</div></div>
  <div class="toolbtn" data-tool="erase">‚ùå</div>
</div>

<div id="board"></div>

<div id="buttons">
  <button id="prevBtn">Edellinen</button>
  <button id="nextBtn">Seuraava</button>
  <button id="newBtn">Uusi</button>

  <!-- ‚òÖ UUSI: Poistonappi ‚òÖ -->
  <button id="deleteBtn" style="background:#b32626;">Poista pulma</button>

  <button id="loadBtn">Lataa JSON</button>
  <button id="saveBtn">Tallenna JSON</button>
</div>

<script>
var puzzles = [];
var current = 0;
var tool = "rabbit";
var foxCount = 0;
var boardDiv = document.getElementById("board");

function emptyPuzzle() {
  return [["o","o","o","o","o"],
          ["o","o","o","o","o"],
          ["o","o","o","o","o"],
          ["o","o","o","o","o"],
          ["o","o","o","o","o"]];
}

/* ‚òÖ UUSI: N√§yt√§ pulman numero ja nimi ‚òÖ */
function renderPuzzleInfo(){
  document.getElementById("puzzleInfo").textContent =
      `Pulma ${current+1} / ${puzzles.length}`;
  document.getElementById("puzzleName").value =
      puzzles[current].name;
}

document.getElementById("puzzleName").oninput = function(){
  puzzles[current].name = this.value;
};

/* ------------------------- */
/*   Toolbutton logic        */
/* ------------------------- */

document.querySelectorAll(".toolbtn").forEach(function(btn) {
  btn.onclick = function() {
    document.querySelectorAll(".toolbtn").forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");
    tool = btn.dataset.tool;
  };
});
document.querySelector(".toolbtn[data-tool='rabbit']").classList.add("selected");

function makeHole(){
  var d=document.createElement("div");
  d.className="hole";
  return d;
}
function makeMushroom(){
  var d=document.createElement("div");
  d.className="mushroom";
  d.textContent="üçÑ";
  return d;
}
function makeRabbit(){
  var d=document.createElement("div");
  d.className="rabbit";
  d.textContent="üê∞";
  return d;
}

function countFoxes(){
  var p = puzzles[current].grid;
  var hasK = false, hasF = false;
  for (var y=0;y<5;y++)
    for (var x=0;x<5;x++){
      if (p[y][x]==="k") hasK=true;
      if (p[y][x]==="f") hasF=true;
    }
  var cnt = (hasK?1:0) + (hasF?1:0);
  return {count:cnt, hasK:hasK, hasF:hasF};
}

function render(){
  boardDiv.innerHTML="";
  var p = puzzles[current].grid;
  var foxGroups={};

  for (var y=0;y<5;y++){
    for (var x=0;x<5;x++){
      var cell=document.createElement("div");
      cell.className="cell";
      var v=p[y][x];

      if (v==="h"){
        cell.appendChild(makeHole());
      } else if (v==="p"){
        cell.appendChild(makeHole());
        cell.appendChild(makeRabbit());
      } else if (v==="m"){
        cell.appendChild(makeMushroom());
      } else if (v==="r"){
        cell.appendChild(makeRabbit());
      } else if (v==="k" || v==="f"){
        var k = v+"-"+x+"-"+y;
        if(!foxGroups[k]){
          if (v==="k"){
            if(x+1<5 && p[y][x+1]==="k")
              foxGroups[k]={id:"fox1",dir:"h",x1:x,y1:y};
            else if (y+1<5 && p[y+1][x]==="k")
              foxGroups[k]={id:"fox1",dir:"v",x1:x,y1:y};
          } else {
            if(x+1<5 && p[y][x+1]==="f")
              foxGroups[k]={id:"fox2",dir:"h",x1:x,y1:y};
            else if (y+1<5 && p[y+1][x]==="f")
              foxGroups[k]={id:"fox2",dir:"v",x1:x,y1:y};
          }
        }
      }

      cell.onclick=(function(xx,yy){return function(){place(xx,yy);};})(x,y);
      boardDiv.appendChild(cell);
    }
  }

  for (var key in foxGroups){
    var f=foxGroups[key];
    var fx=document.createElement("div");
    fx.className="fox "+f.id;
    fx.innerHTML="ü¶ä";
    var gap=4,pad=12,size=72;
    fx.style.left = (pad + f.x1*(size+gap))+"px";
    fx.style.top  = (pad + f.y1*(size+gap))+"px";
    if (f.dir==="h"){
      fx.style.width=(size*2+gap)+"px";
      fx.style.height=size+"px";
    } else {
      fx.style.width=size+"px";
      fx.style.height=(size*2+gap)+"px";
    }
    boardDiv.appendChild(fx);
  }

  renderPuzzleInfo();
}

function place(x, y) {
  var p = puzzles[current].grid;
  
  if (tool === "erase") {
    var v = p[y][x];
    if (v === "k" || v === "f") {
      var c = v;
      p[y][x] = "o";
      if (x > 0 && p[y][x - 1] === c) p[y][x - 1] = "o";
      if (x < 4 && p[y][x + 1] === c) p[y][x + 1] = "o";
      if (y > 0 && p[y - 1][x] === c) p[y - 1][x] = "o";
      if (y < 4 && p[y + 1][x] === c) p[y + 1][x] = "o";
      foxCount = countFoxes();
    } else {
      p[y][x] = "o";
    }
  } else if (tool === "rabbit") {
    p[y][x] = "r";
  } else if (tool === "mushroom") {
    p[y][x] = "m";
  } else if (tool === "hole") {
    p[y][x] = "h";
  } else if (tool === "burrow") {
    p[y][x] = "p";
  } else if (tool === "foxh") {
    var info = countFoxes();
    if (info.count < 2) {
      var code = info.hasK ? "f" : "k";
      if (x < 4 && p[y][x] === "o" && p[y][x + 1] === "o") {
        p[y][x] = code;
        p[y][x + 1] = code;
        foxCount = info.count + 1;
      }
    }
  } else if (tool === "foxv") {
    var info = countFoxes();
    if (info.count < 2) {
      var code = info.hasK ? "f" : "k";
      if (y < 4 && p[y][x] === "o" && p[y + 1][x] === "o") {
        p[y][x] = code;
        p[y + 1][x] = code;
        foxCount = info.count + 1;
      }
    }
  }
  
  render();
}
/* ------------------------------ */
/* Napit                          */
/* ------------------------------ */

document.getElementById("newBtn").onclick=function(){
  puzzles.push({
    name: "Uusi pulma",
    grid: emptyPuzzle()
  });
  current=puzzles.length-1;
  foxCount=0;
  render();
};

document.getElementById("prevBtn").onclick=function(){
  if(current>0) current--;
  foxCount=countFoxes();
  render();
};

document.getElementById("nextBtn").onclick=function(){
  if(current<puzzles.length-1) current++;
  foxCount=countFoxes();
  render();
};

/* ‚òÖ UUSI: Poista pulma ‚òÖ */
document.getElementById("deleteBtn").onclick=function(){
  if(puzzles.length<=1){
    alert("Et voi poistaa viimeist√§ pulmaa.");
    return;
  }
  puzzles.splice(current,1);
  if(current>=puzzles.length) current=puzzles.length-1;
  foxCount=countFoxes();
  render();
};

/* Tallennus ja lataus */

document.getElementById("saveBtn").onclick=function(){
  var blob=new Blob([JSON.stringify(puzzles,null,2)],{type:"application/json"});
  var a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="jumpin_puzzles.json";
  a.click();
};

document.getElementById("loadBtn").onclick=function(){
  var inp=document.createElement("input");
  inp.type="file";
  inp.accept=".json";
  inp.onchange=function(){
    var file=inp.files[0];
    var r=new FileReader();
    r.onload=function(){
let loaded = JSON.parse(r.result);

/* Jos vanha formaatti ‚Üí muunnos uuteen */
if (Array.isArray(loaded) && Array.isArray(loaded[0]) && Array.isArray(loaded[0][0])) {
    // Vanha: [[grid],[grid],...]
    puzzles = loaded.map((grid, idx) => ({
        name: "Pulma " + (idx+1),
        grid: grid
    }));
}
/* Uusi formaatti sellaisenaan */
else if (Array.isArray(loaded) && typeof loaded[0] === "object" && loaded[0].grid) {
    puzzles = loaded;
}
/* Virheellinen tiedosto */
else {
    alert("JSON-muoto ei kelpaa.");
    return;
}

current = 0;
foxCount = countFoxes();
render();

    };
    r.readAsText(file);
  };
  inp.click();
};

/* K√§ynnist√§ editori yhdell√§ tyhj√§ll√§ pulmalla */
puzzles=[{
  name:"Pulma 1",
  grid: emptyPuzzle()
}];
render();
</script>

</body>
</html>
